name: 多平台打包并上传到Release中

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'v1.0.0'

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      # 7. 检出代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 8. 提取不含有 'v' 开头的标签字符
      - name: Extract version without 'v'
        run: |
          $TAG_NAME = "${{ github.event.inputs.tag_name }}"
          Write-Output "Input tag name: $TAG_NAME"
          if ($TAG_NAME.StartsWith("v")) {
            $VERSION = $TAG_NAME.Substring(1)
          } else {
            $VERSION = $TAG_NAME
          }
          Write-Output "Extracted version: $VERSION"
          echo "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # 9. 设置 Java 23 (Oracle OpenJDK 23.0.1 - x64)
      - name: Set up JDK 18
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '18'
          architecture: 'x64'

      # 10. 验证 Java 版本
      - name: Verify Java version
        run: java -version

      # 11. 赋予 Gradle 执行权限
      - name: grant execute permission for gradlew
        run: chmod +x gradlew

      # 12. 运行 Gradle 任务，生成 .exe 文件（启用详细日志）
      - name: Run Gradle packageReleaseExe
        run: ./gradlew packageReleaseExe
        continue-on-error: true

      # 13. 捕获标准输出日志并输出到 GitHub Actions 日志
      - name: Capture and output standard log
        run: |
          $stdoutLog = Get-ChildItem -Path "D:\a\ComposeApp-projects\ComposeApp-projects\composeApp\build\compose\logs\packageReleaseExe" -Filter "*-out.txt" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($stdoutLog) {
              Write-Output "Standard output log content:"
              Get-Content -Path $stdoutLog.FullName
          } else {
              Write-Output "No standard output log found."
          }
        continue-on-error: true

      # 14. 捕获错误日志并输出到 GitHub Actions 日志
      - name: Capture and output error log
        run: |
          $stderrLog = Get-ChildItem -Path "D:\a\ComposeApp-projects\ComposeApp-projects\composeApp\build\compose\logs\packageReleaseExe" -Filter "*-err.txt" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($stderrLog) {
              Write-Output "Error log content:"
              Get-Content -Path $stderrLog.FullName
              echo "ERROR_LOG_PATH=$($stderrLog.FullName)" | Out-File -FilePath
          } else {
              Write-Output "No error output log found."
          }
        continue-on-error: true
